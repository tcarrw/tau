<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>τ Dynamics · Temporal Charge Exploration</title>
  <meta name="description" content="Interactive exploration of temporal charge: nuclear spectra transformation and molecular cascade dynamics.">
  <style>
:root{
  --bg:#0a0b0d;
  --ink:#f4f4f4;
  --ink-muted:#c2d0e9;
  --panel:rgba(15,21,36,0.95);
  --line:rgba(255,255,255,0.1);
  --accent:#4ac0b4;
  --accent-purple:#a572cf;
  --accent-gold:#e6c04d;
  --red:#c64747;
}

*{box-sizing:border-box;margin:0;padding:0;}

body{
  background:var(--bg);
  color:var(--ink);
  font-family:system-ui,-apple-system,sans-serif;
  line-height:1.7;
  min-height:100vh;
}

.container{
  max-width:1200px;
  margin:0 auto;
  padding:2rem;
}

/* HEADER */
header{
  text-align:center;
  margin-bottom:3rem;
  padding-bottom:2rem;
  border-bottom:1px solid var(--line);
}

.logo{
  font-size:4rem;
  font-weight:700;
  color:var(--accent);
  margin-bottom:0.5rem;
}

h1{
  font-size:2.5rem;
  font-weight:700;
  margin-bottom:0.5rem;
}

.subtitle{
  font-size:1.1rem;
  color:var(--ink-muted);
}

/* INTRO SECTION */
.intro{
  background:var(--panel);
  padding:2rem;
  border-radius:12px;
  border:1px solid var(--line);
  margin-bottom:3rem;
}

.intro h2{
  font-size:1.8rem;
  margin-bottom:1rem;
  color:var(--accent);
}

.intro p{
  margin-bottom:1rem;
  color:var(--ink-muted);
}

.eq{
  background:rgba(0,0,0,0.4);
  padding:1rem;
  margin:1rem 0;
  border-radius:8px;
  font-family:monospace;
  font-size:1rem;
  text-align:center;
  border:1px solid var(--line);
  color:var(--accent);
}

.intro a{
  color:var(--accent);
  text-decoration:none;
  font-weight:500;
}

.intro a:hover{
  text-decoration:underline;
}

/* DEMO SECTIONS */
.demo-section{
  background:var(--panel);
  padding:2rem;
  border-radius:12px;
  border:1px solid var(--line);
  margin-bottom:3rem;
}

.demo-section h2{
  font-size:2rem;
  margin-bottom:0.5rem;
  color:var(--accent-purple);
}

.demo-section h3{
  font-size:1.3rem;
  margin:1.5rem 0 0.75rem;
  color:var(--ink);
}

.demo-section p{
  margin-bottom:1rem;
  color:var(--ink-muted);
}

.demo-grid{
  display:grid;
  grid-template-columns:2fr 1fr;
  gap:2rem;
  margin-top:2rem;
}

@media(max-width:900px){
  .demo-grid{grid-template-columns:1fr;}
}

/* CANVAS */
.canvas-area{
  background:#000;
  border-radius:8px;
  overflow:hidden;
  aspect-ratio:1;
  position:relative;
}

canvas{
  width:100%;
  height:100%;
  display:block;
  cursor:crosshair;
}

/* CONTROLS */
.controls{
  display:flex;
  flex-direction:column;
  gap:1rem;
}

.control-group{
  display:flex;
  flex-direction:column;
  gap:0.5rem;
}

.control-label{
  font-size:0.9rem;
  font-weight:600;
  color:var(--ink);
}

.control-desc{
  font-size:0.85rem;
  color:var(--ink-muted);
  margin-top:0.25rem;
}

.btn-row{
  display:flex;
  gap:0.5rem;
  flex-wrap:wrap;
}

.btn{
  padding:0.75rem 1rem;
  background:rgba(255,255,255,0.05);
  border:1px solid var(--line);
  border-radius:6px;
  color:var(--ink);
  cursor:pointer;
  font-size:0.9rem;
  font-weight:500;
  transition:all 0.2s;
  flex:1;
  min-width:100px;
  text-align:center;
}

.btn:hover{
  background:rgba(255,255,255,0.1);
  border-color:var(--accent);
}

.btn.active{
  background:var(--accent);
  color:#000;
  border-color:var(--accent);
}

.slider-group{
  display:flex;
  flex-direction:column;
  gap:0.5rem;
}

.slider-label{
  font-size:0.85rem;
  color:var(--ink-muted);
  display:flex;
  justify-content:space-between;
}

input[type="range"]{
  width:100%;
  height:6px;
  background:rgba(255,255,255,0.1);
  border-radius:3px;
  outline:none;
}

input[type="range"]::-webkit-slider-thumb{
  appearance:none;
  width:16px;
  height:16px;
  background:var(--accent);
  border-radius:50%;
  cursor:pointer;
}

input[type="range"]::-moz-range-thumb{
  width:16px;
  height:16px;
  background:var(--accent);
  border-radius:50%;
  cursor:pointer;
  border:none;
}

.stats{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:0.5rem;
  font-size:0.85rem;
}

.stat{
  background:rgba(0,0,0,0.3);
  padding:0.5rem;
  border-radius:6px;
  text-align:center;
}

.stat-label{
  color:var(--ink-muted);
  font-size:0.75rem;
  text-transform:uppercase;
  letter-spacing:0.05em;
}

.stat-value{
  color:var(--accent);
  font-size:1.2rem;
  font-weight:700;
}

.legend{
  display:grid;
  gap:0.5rem;
  font-size:0.85rem;
}

.legend-item{
  display:flex;
  align-items:center;
  gap:0.5rem;
}

.legend-box{
  width:16px;
  height:16px;
  border-radius:3px;
  border:1px solid var(--line);
}

/* INPUT TABLE */
.input-table{
  width:100%;
  background:rgba(0,0,0,0.3);
  border-radius:8px;
  padding:1rem;
  margin:1rem 0;
}

.input-table textarea{
  width:100%;
  min-height:120px;
  background:rgba(0,0,0,0.4);
  border:1px solid var(--line);
  border-radius:6px;
  padding:0.75rem;
  color:var(--ink);
  font-family:monospace;
  font-size:0.9rem;
  resize:vertical;
}

.preset-btns{
  display:flex;
  gap:0.5rem;
  margin-top:0.5rem;
  flex-wrap:wrap;
}

.preset-btn{
  padding:0.5rem 0.75rem;
  background:rgba(255,255,255,0.05);
  border:1px solid var(--line);
  border-radius:6px;
  color:var(--ink);
  cursor:pointer;
  font-size:0.85rem;
  transition:all 0.2s;
}

.preset-btn:hover{
  background:rgba(255,255,255,0.1);
  border-color:var(--accent-gold);
}

/* CHART CONTAINER */
.chart-container{
  background:#000;
  border-radius:8px;
  padding:1rem;
  min-height:400px;
  position:relative;
}

.chart-canvas{
  width:100%;
  height:400px;
}

/* FOOTER */
.earth-footer{
  margin-top:3rem;
  padding-top:2rem;
  border-top:1px solid var(--line);
  text-align:center;
  color:var(--ink-muted);
  font-size:0.9rem;
  line-height:1.8;
}

.earth-footer a{
  color:var(--accent);
  text-decoration:none;
  font-weight:600;
}

.earth-footer a:hover{
  text-decoration:underline;
}

.footer-links{
  margin-top:1.5rem;
  padding-top:1.5rem;
  border-top:1px solid var(--line);
}

.footer-meta{
  margin-top:1rem;
  font-size:0.85rem;
  opacity:0.7;
}

ul{
  margin:0.5rem 0 1rem 1.5rem;
  color:var(--ink-muted);
}

li{
  margin-bottom:0.25rem;
}

@media(max-width:768px){
  .container{padding:1rem;}
  h1{font-size:2rem;}
  .logo{font-size:3rem;}
}
  </style>
</head>
<body>

<div class="container">
  
  <header>
    <div class="logo">τ</div>
    <h1>Temporal Charge Dynamics</h1>
    <p class="subtitle">Exploring τ = ℏ/E through nuclear spectra and molecular cascades</p>
  </header>

  <!-- INTRODUCTION -->
  <section class="intro">
    <h2>What is Temporal Charge?</h2>
    
    <p>Temporal charge τ (tau) is the <strong>Compton time</strong>—the fundamental oscillation period of any mass or energy:</p>
    
    <div class="eq">τ = ℏ/(mc²) = ℏ/E</div>
    
    <p>Where ℏ is the reduced Planck constant, m is mass, c is the speed of light, and E is energy. Dimensionally, τ has units of time [seconds].</p>
    
    <p><strong>Physical interpretation:</strong> τ represents the characteristic "tick rate" of matter. Higher energy → shorter τ (faster oscillation). Lower energy → longer τ (slower oscillation).</p>
    
    <p>The central question: <strong>Does expressing physical systems in τ-space reveal structure not evident in energy space?</strong></p>
    
    <p>This page explores two applications:</p>
    <ul>
      <li><strong>Nuclear Spectra:</strong> Do atomic nuclei show harmonic patterns in τ-space? (<a href="https://time.plnt.earth">Theory at time.plnt.earth</a>)</li>
      <li><strong>Molecular Cascades:</strong> How does τ accumulate in prebiotic chemistry? (<a href="https://42.plnt.earth">Applications at 42.plnt.earth</a>)</li>
    </ul>
  </section>

  <!-- DEMO 1: NUCLEAR SPECTRA -->
  <section class="demo-section">
    <h2>Demo 1: Nuclear Spectra Transformation</h2>
    
    <p>Nuclear excited states typically show irregular energy spacing. The hypothesis: expressing these levels as temporal charges τₙ = ℏ/Eₙ may reveal harmonic or monotonic structure.</p>
    
    <p>This test comes from <a href="https://time.plnt.earth">time.plnt.earth</a>'s core framework. Enter energy levels (in MeV) and see if τ-space reveals simpler patterns.</p>

    <div class="demo-grid">
      
      <!-- CHART -->
      <div class="chart-area">
        <canvas id="spectraCanvas"></canvas>
      </div>

      <!-- CONTROLS -->
      <div class="controls">
        
        <div class="control-group">
          <div class="control-label">Energy Levels (MeV)</div>
          <div class="control-desc">Enter one energy per line. Example: Lead-208 excited states.</div>
          <div class="input-table">
            <textarea id="energyInput" placeholder="0.0&#10;2.615&#10;4.086&#10;4.323&#10;4.610"></textarea>
          </div>
          <div class="preset-btns">
            <button class="preset-btn" id="presetPb208">²⁰⁸Pb</button>
            <button class="preset-btn" id="presetCa48">⁴⁸Ca</button>
            <button class="preset-btn" id="presetO16">¹⁶O</button>
          </div>
        </div>

        <div class="control-group">
          <button class="btn active" id="transformBtn">Transform to τ-Space</button>
        </div>

        <div class="control-group">
          <div class="control-label">Display Options</div>
          <div class="btn-row">
            <button class="btn active" id="showEnergy">Energy</button>
            <button class="btn" id="showTau">τ-Space</button>
            <button class="btn" id="showBoth">Both</button>
          </div>
        </div>

        <div class="stats">
          <div class="stat">
            <div class="stat-label">Levels</div>
            <div class="stat-value" id="levelCount">0</div>
          </div>
          <div class="stat">
            <div class="stat-label">Range</div>
            <div class="stat-value" id="energyRange">—</div>
          </div>
        </div>

      </div>

    </div>

    <h3>What to Look For</h3>
    <ul>
      <li><strong>Linear τ spacing:</strong> τₙ = τ₀ · n (harmonic oscillator)</li>
      <li><strong>Quadratic τ spacing:</strong> τₙ = τ₀ · n² (hydrogen-like)</li>
      <li><strong>Other functional forms:</strong> Power laws, exponentials</li>
      <li><strong>Random scatter:</strong> No apparent τ-structure</li>
    </ul>

    <p><strong>Interpretation:</strong> If τ-space reveals simpler patterns than energy space, it suggests time may be a more fundamental coordinate for quantum systems. See full analysis at <a href="https://time.plnt.earth">time.plnt.earth</a>.</p>
  </section>

  <!-- DEMO 2: MOLECULAR CASCADES -->
  <section class="demo-section">
    <h2>Demo 2: Molecular τ-Cascades</h2>
    
    <p>This demo models how temporal charge accumulates in molecular systems—the chemistry behind <a href="https://42.plnt.earth">42.plnt.earth</a>'s τ-life framework.</p>
    
    <p><strong>Scenario:</strong> Prebiotic chemistry on early Earth (or in <a href="https://42.plnt.earth">Bennu asteroid samples</a>). Molecules like glucose, ribose, and amino acids each carry temporal charge τ = ℏ/E. When enough τ accumulates in a region, chemical reactions cascade—modeling metabolic pathways.</p>

    <p>This demonstrates <strong>self-organized criticality</strong> in chemistry, following Bak-Tang-Wiesenfeld's sandpile model (Phys. Rev. Lett., 1987).</p>

    <div class="demo-grid">
      
      <!-- CANVAS -->
      <div class="canvas-area">
        <canvas id="cascadeCanvas" width="600" height="600"></canvas>
      </div>

      <!-- CONTROLS -->
      <div class="controls">
        
        <div class="control-group">
          <div class="control-label">Simulation</div>
          <div class="btn-row">
            <button class="btn" id="stepBtn">Step</button>
            <button class="btn" id="playBtn">Play</button>
            <button class="btn" id="resetBtn">Reset</button>
          </div>
        </div>

        <div class="control-group">
          <div class="control-label">Molecule Type</div>
          <div class="control-desc">Different molecules have different τ values based on their energy content.</div>
          <div class="btn-row">
            <button class="btn active" id="glucoseBtn">Glucose<br><small>τ = 2.3×10⁻²⁴ s</small></button>
            <button class="btn" id="atpBtn">ATP<br><small>τ = 1.1×10⁻²⁴ s</small></button>
          </div>
          <div class="btn-row">
            <button class="btn" id="riboseBtn">Ribose<br><small>τ = 3.5×10⁻²⁴ s</small></button>
            <button class="btn" id="aminoBtn">Amino Acid<br><small>τ = 5×10⁻²⁴ s</small></button>
          </div>
        </div>

        <div class="control-group">
          <div class="slider-group">
            <div class="slider-label">
              <span>Speed</span>
              <span id="speedVal">100 ms</span>
            </div>
            <input type="range" id="speedSlider" min="10" max="500" value="100">
          </div>
        </div>

        <div class="control-group">
          <div class="slider-group">
            <div class="slider-label">
              <span>Threshold (activation energy)</span>
              <span id="thresholdVal">4.0</span>
            </div>
            <input type="range" id="thresholdSlider" min="2" max="10" step="0.5" value="4">
          </div>
          <div class="control-desc">How much τ must accumulate before a reaction cascade occurs.</div>
        </div>

        <div class="stats">
          <div class="stat">
            <div class="stat-label">Total τ</div>
            <div class="stat-value" id="totalTau">0</div>
          </div>
          <div class="stat">
            <div class="stat-label">Cascades</div>
            <div class="stat-value" id="cascadeCount">0</div>
          </div>
        </div>

        <div class="legend">
          <div class="legend-item">
            <div class="legend-box" style="background:#4ac0b4"></div>
            <span>Low τ accumulation</span>
          </div>
          <div class="legend-item">
            <div class="legend-box" style="background:#a572cf"></div>
            <span>Near threshold</span>
          </div>
          <div class="legend-item">
            <div class="legend-box" style="background:#e6c04d"></div>
            <span>Cascade triggering</span>
          </div>
        </div>

      </div>

    </div>

    <h3>Physical Interpretation</h3>
    <ul>
      <li><strong>Cells = molecular sites:</strong> Each grid cell represents a spatial region containing molecules</li>
      <li><strong>τ accumulation:</strong> As molecules diffuse in, total τ increases (like charging a battery)</li>
      <li><strong>Threshold:</strong> Activation energy for chemical reactions (ATP synthesis, polymerization)</li>
      <li><strong>Cascade:</strong> When threshold is reached, reaction releases products that trigger neighboring reactions</li>
    </ul>

    <p><strong>Connection to life:</strong> This models the <strong>sustained ordered τ-flux</strong> described at <a href="https://42.plnt.earth">42.plnt.earth</a>. Life maintains itself through continuous cycling of temporal charge—glucose → ATP → work → heat. The cascade pattern shows how metabolic pathways self-organize.</p>

    <p><strong>Bennu connection:</strong> NASA's <a href="https://42.plnt.earth">OSIRIS-REx samples</a> found glucose, ribose, and "space gum" polymers. These are the actual τ-storage molecules that enable life. This demo shows how they could self-organize into reaction networks.</p>
  </section>

  <!-- FOOTER -->
  <footer class="earth-footer">
    <p>
      <a href="https://earth.plnt.earth">Earth</a> is the ground beneath all of this. It stays, no matter what changes above. A place to hold joy, music, and motion—untouched by the noise. If the system shifts, Earth remains.
    </p>
    
    <div class="footer-links">
      <strong>Explore:</strong>
      <a href="https://time.plnt.earth">Time (τ Framework)</a> ·
      <a href="https://42.plnt.earth">42 (τ-Life & Bennu)</a> ·
      <a href="https://zeta.plnt.earth">Zeta (ζ Regularization)</a> ·
      <a href="https://infinity.plnt.earth">Infinity (∞ Mathematics)</a>
    </div>
    
    <div class="footer-meta">
      τ Dynamics · © 2025 · Creative Commons BY-NC-SA 4.0
    </div>
  </footer>

</div>

<script>
// DEMO 1: NUCLEAR SPECTRA TRANSFORMATION
const spectraCanvas = document.getElementById('spectraCanvas');
const spectraCtx = spectraCanvas.getContext('2d');

const HBAR = 1.055e-34; // J·s
const MEV_TO_J = 1.602e-13; // MeV to Joules conversion

let energyLevels = [];
let tauLevels = [];
let displayMode = 'energy'; // 'energy', 'tau', 'both'

// Presets for nuclear data
const presets = {
  pb208: [0, 2.615, 4.086, 4.323, 4.610, 4.842, 5.279],
  ca48: [0, 3.832, 4.507, 5.281, 6.288, 7.416],
  o16: [0, 6.049, 6.130, 6.917, 7.117, 8.872]
};

function parseEnergyInput() {
  const text = document.getElementById('energyInput').value;
  const lines = text.split('\n').filter(l => l.trim());
  energyLevels = lines.map(l => parseFloat(l)).filter(e => !isNaN(e) && e >= 0);
  tauLevels = energyLevels.map(E => {
    const E_joules = E * MEV_TO_J;
    return HBAR / E_joules; // τ = ℏ/E
  });
  
  document.getElementById('levelCount').textContent = energyLevels.length;
  if (energyLevels.length > 0) {
    const range = (Math.max(...energyLevels) - Math.min(...energyLevels)).toFixed(2);
    document.getElementById('energyRange').textContent = `${range} MeV`;
  }
  
  renderSpectra();
}

function renderSpectra() {
  const w = spectraCanvas.width;
  const h = spectraCanvas.height;
  
  spectraCtx.fillStyle = '#000';
  spectraCtx.fillRect(0, 0, w, h);
  
  if (energyLevels.length === 0) {
    spectraCtx.fillStyle = '#c2d0e9';
    spectraCtx.font = '14px system-ui';
    spectraCtx.textAlign = 'center';
    spectraCtx.fillText('Enter energy levels to begin', w/2, h/2);
    return;
  }
  
  const margin = 60;
  const plotW = w - 2*margin;
  const plotH = h - 2*margin;
  
  // Draw axes
  spectraCtx.strokeStyle = '#2a3348';
  spectraCtx.lineWidth = 2;
  spectraCtx.beginPath();
  spectraCtx.moveTo(margin, margin);
  spectraCtx.lineTo(margin, h - margin);
  spectraCtx.lineTo(w - margin, h - margin);
  spectraCtx.stroke();
  
  // Labels
  spectraCtx.fillStyle = '#a3acc2';
  spectraCtx.font = '12px system-ui';
  spectraCtx.textAlign = 'center';
  spectraCtx.fillText('Level Index', w/2, h - 20);
  
  spectraCtx.save();
  spectraCtx.translate(20, h/2);
  spectraCtx.rotate(-Math.PI/2);
  spectraCtx.fillText(displayMode === 'energy' ? 'Energy (MeV)' : 'τ (×10⁻²¹ s)', 0, 0);
  spectraCtx.restore();
  
  // Plot data
  const data = displayMode === 'energy' ? energyLevels : tauLevels.map(t => t * 1e21);
  const maxVal = Math.max(...data);
  const minVal = Math.min(...data);
  const range = maxVal - minVal || 1;
  
  spectraCtx.strokeStyle = '#4ac0b4';
  spectraCtx.fillStyle = '#4ac0b4';
  spectraCtx.lineWidth = 2;
  
  for (let i = 0; i < data.length; i++) {
    const x = margin + (i / (data.length - 1 || 1)) * plotW;
    const y = h - margin - ((data[i] - minVal) / range) * plotH;
    
    spectraCtx.beginPath();
    spectraCtx.arc(x, y, 4, 0, Math.PI * 2);
    spectraCtx.fill();
    
    if (i > 0) {
      const prevX = margin + ((i-1) / (data.length - 1)) * plotW;
      const prevY = h - margin - ((data[i-1] - minVal) / range) * plotH;
      spectraCtx.beginPath();
      spectraCtx.moveTo(prevX, prevY);
      spectraCtx.lineTo(x, y);
      spectraCtx.stroke();
    }
  }
}

// Event listeners for Demo 1
document.getElementById('transformBtn').addEventListener('click', parseEnergyInput);

document.getElementById('energyInput').addEventListener('input', () => {
  parseEnergyInput();
});

document.getElementById('presetPb208').addEventListener('click', () => {
  document.getElementById('energyInput').value = presets.pb208.join('\n');
  parseEnergyInput();
});

document.getElementById('presetCa48').addEventListener('click', () => {
  document.getElementById('energyInput').value = presets.ca48.join('\n');
  parseEnergyInput();
});

document.getElementById('presetO16').addEventListener('click', () => {
  document.getElementById('energyInput').value = presets.o16.join('\n');
  parseEnergyInput();
});

document.getElementById('showEnergy').addEventListener('click', function() {
  displayMode = 'energy';
  document.querySelectorAll('#showEnergy, #showTau, #showBoth').forEach(b => b.classList.remove('active'));
  this.classList.add('active');
  renderSpectra();
});

document.getElementById('showTau').addEventListener('click', function() {
  displayMode = 'tau';
  document.querySelectorAll('#showEnergy, #showTau, #showBoth').forEach(b => b.classList.remove('active'));
  this.classList.add('active');
  renderSpectra();
});

document.getElementById('showBoth').addEventListener('click', function() {
  displayMode = 'both';
  document.querySelectorAll('#showEnergy, #showTau, #showBoth').forEach(b => b.classList.remove('active'));
  this.classList.add('active');
  renderSpectra();
});

// Initialize Demo 1
spectraCanvas.width = spectraCanvas.parentElement.clientWidth;
spectraCanvas.height = spectraCanvas.parentElement.clientWidth;
renderSpectra();

// DEMO 2: MOLECULAR CASCADE SIMULATION
const cascadeCanvas = document.getElementById('cascadeCanvas');
const cascadeCtx = cascadeCanvas.getContext('2d');

const GRID_SIZE = 100;
const CELL_SIZE = cascadeCanvas.width / GRID_SIZE;

// Molecular τ values (scaled for visualization)
const molecules = {
  glucose: { tau: 2.3, name: 'Glucose' },
  atp: { tau: 1.1, name: 'ATP' },
  ribose: { tau: 3.5, name: 'Ribose' },
  amino: { tau: 5.0, name: 'Amino Acid' }
};

let grid = [];
let currentMolecule = 'glucose';
let threshold = 4;
let speed = 100;
let playing = false;
let playInterval = null;
let cascadeStats = { totalTau: 0, cascades: 0 };

function initGrid() {
  grid = Array(GRID_SIZE).fill(0).map(() => Array(GRID_SIZE).fill(0));
  cascadeStats = { totalTau: 0, cascades: 0 };
  updateCascadeStats();
  renderCascade();
}

function addMolecule(x, y) {
  if (x < 0 || x >= GRID_SIZE || y < 0 || y >= GRID_SIZE) return;
  
  const tau = molecules[currentMolecule].tau;
  grid[y][x] += tau;
  cascadeStats.totalTau += tau;
  
  if (Math.abs(grid[y][x]) >= threshold) {
    triggerCascade(x, y);
  }
}

function triggerCascade(x, y) {
  let cascadeSize = 0;
  const queue = [[x, y]];
  const visited = new Set();
  
  while (queue.length > 0) {
    const [cx, cy] = queue.shift();
    const key = `${cx},${cy}`;
    
    if (visited.has(key)) continue;
    visited.add(key);
    
    if (cx < 0 || cx >= GRID_SIZE || cy < 0 || cy >= GRID_SIZE) continue;
    if (Math.abs(grid[cy][cx]) < threshold) continue;
    
    cascadeSize++;
    const excess = grid[cy][cx];
    grid[cy][cx] = 0;
    
    [[cx+1,cy], [cx-1,cy], [cx,cy+1], [cx,cy-1]].forEach(([nx, ny]) => {
      if (nx >= 0 && nx < GRID_SIZE && ny >= 0 && ny < GRID_SIZE) {
        grid[ny][nx] += excess / 4;
        if (Math.abs(grid[ny][nx]) >= threshold) {
          queue.push([nx, ny]);
        }
      }
    });
  }
  
  if (cascadeSize > 0) {
    cascadeStats.cascades++;
  }
}

function renderCascade() {
  cascadeCtx.fillStyle = '#000';
  cascadeCtx.fillRect(0, 0, cascadeCanvas.width, cascadeCanvas.height);
  
  for (let y = 0; y < GRID_SIZE; y++) {
    for (let x = 0; x < GRID_SIZE; x++) {
      const tau = grid[y][x];
      if (tau === 0) continue;
      
      const intensity = Math.min(Math.abs(tau) / threshold, 1);
      let r, g, b;
      
      if (Math.abs(tau) > threshold * 0.8) {
        // Near threshold - gold
        r = 230 * intensity; g = 192 * intensity; b = 77 * intensity;
      } else if (Math.abs(tau) > threshold * 0.5) {
        // Medium - purple
        r = 165 * intensity; g = 114 * intensity; b = 207 * intensity;
      } else {
        // Low - blue
        r = 74 * intensity; g = 192 * intensity; b = 180 * intensity;
      }
      
      cascadeCtx.fillStyle = `rgb(${r},${g},${b})`;
      cascadeCtx.fillRect(x * CELL_SIZE, y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
    }
  }
  
  updateCascadeStats();
}

function updateCascadeStats() {
  document.getElementById('totalTau').textContent = cascadeStats.totalTau.toFixed(1);
  document.getElementById('cascadeCount').textContent = cascadeStats.cascades;
}

function step() {
  const x = Math.floor(Math.random() * GRID_SIZE);
  const y = Math.floor(Math.random() * GRID_SIZE);
  addMolecule(x, y);
  renderCascade();
}

function togglePlay() {
  playing = !playing;
  const btn = document.getElementById('playBtn');
  
  if (playing) {
    btn.textContent = 'Pause';
    btn.classList.add('active');
    playInterval = setInterval(step, speed);
  } else {
    btn.textContent = 'Play';
    btn.classList.remove('active');
    clearInterval(playInterval);
  }
}

// Event listeners for Demo 2
cascadeCanvas.addEventListener('click', (e) => {
  const rect = cascadeCanvas.getBoundingClientRect();
  const x = Math.floor((e.clientX - rect.left) / CELL_SIZE);
  const y = Math.floor((e.clientY - rect.top) / CELL_SIZE);
  addMolecule(x, y);
  renderCascade();
});

document.getElementById('stepBtn').addEventListener('click', step);
document.getElementById('playBtn').addEventListener('click', togglePlay);

document.getElementById('resetBtn').addEventListener('click', () => {
  if (playing) togglePlay();
  initGrid();
});

['glucoseBtn', 'atpBtn', 'riboseBtn', 'aminoBtn'].forEach(id => {
  document.getElementById(id).addEventListener('click', function() {
    ['glucoseBtn', 'atpBtn', 'riboseBtn', 'aminoBtn'].forEach(i => {
      document.getElementById(i).classList.remove('active');
    });
    this.classList.add('active');
    
    const map = { glucoseBtn: 'glucose', atpBtn: 'atp', riboseBtn: 'ribose', aminoBtn: 'amino' };
    currentMolecule = map[id];
  });
});

document.getElementById('speedSlider').addEventListener('input', (e) => {
  speed = parseInt(e.target.value);
  document.getElementById('speedVal').textContent = `${speed} ms`;
  if (playing) {
    clearInterval(playInterval);
    playInterval = setInterval(step, speed);
  }
});

document.getElementById('thresholdSlider').addEventListener('input', (e) => {
  threshold = parseFloat(e.target.value);
  document.getElementById('thresholdVal').textContent = threshold.toFixed(1);
});

// Initialize Demo 2
initGrid();

// Resize handler
window.addEventListener('resize', () => {
  spectraCanvas.width = spectraCanvas.parentElement.clientWidth;
  spectraCanvas.height = spectraCanvas.parentElement.clientWidth;
  renderSpectra();
});
</script>

</body>
</html>
